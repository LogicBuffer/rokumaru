<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ロクマル 管理者ダッシュボード</title>
    
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Supabase & Chart.js (安定版CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 設定ファイル -->
    <script src="./config.js"></script>

    <style>body { background-color: #f1f5f9; font-family: sans-serif; }</style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 設定読み込み ---
        const config = window.ROKUMARU_CONFIG || {
            supabaseUrl: "https://oebdycuvvajivxumvgoo.supabase.co",
            supabaseKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9lYmR5Y3V2dmFqaXZ4dW12Z29vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5NjY3OTgsImV4cCI6MjA4MzU0Mjc5OH0.WjrWr-WpBhBpVRc2qLTDUtaqPgXrHSBf4WcO-NzhufA"
        };
        
        let supabase = null;
        const { useState, useEffect, useRef } = React;
        const Icon = ({ name, size = 16, className = "" }) => {
            useEffect(() => { if(window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- 認証画面 ---
        const AuthScreen = () => {
            const [status, setStatus] = useState('idle');
            const login = async () => {
                if (!supabase) return alert("システムエラー");
                try {
                    setStatus('checking');
                    await supabase.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: window.location.href } });
                } catch (error) { setStatus('idle'); alert("ログインエラー: " + error.message); }
            };
            return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-slate-900 text-white p-6">
                    <div className="w-full max-w-md bg-slate-800 p-8 rounded-2xl shadow-xl text-center">
                        <h1 className="text-2xl font-bold tracking-widest mb-8"><span className="bg-blue-600 text-white text-xs px-2 py-1 rounded mr-3">ADMIN</span>ロクマル 管理画面</h1>
                        <button onClick={login} className="w-full bg-white text-slate-900 font-bold py-3 rounded-lg flex items-center justify-center space-x-3">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" className="w-5 h-5" /><span>Googleでログイン</span>
                        </button>
                    </div>
                </div>
            );
        };

        // --- メイン管理画面 ---
        const AdminDashboard = ({ user, onLogout }) => {
            const [view, setView] = useState('dashboard'); // dashboard | members
            const [expenses, setExpenses] = useState([]);
            const [members, setMembers] = useState([]);
            const [loading, setLoading] = useState(false);
            const [newMemberEmail, setNewMemberEmail] = useState("");
            
            // フィルタ用
            const [filterMonth, setFilterMonth] = useState(new Date().toISOString().slice(0, 7));
            const [filterUser, setFilterUser] = useState("");

            // データ取得
            const refreshData = async () => {
                if(!supabase) return;
                setLoading(true);

                // 1. メンバー一覧取得
                const { data: memberData } = await supabase.from('team_members').select('*');
                setMembers(memberData || []);

                // 2. 経費データ取得（RLSにより、自分＋メンバーの分が自動で取れる）
                const { data: expenseData, error } = await supabase
                    .from('expenses')
                    .select('*')
                    .order('date', { ascending: false });
                
                if (error) alert("データ取得エラー: " + error.message);
                else setExpenses(expenseData || []);
                
                setLoading(false);
            };

            useEffect(() => { refreshData(); }, []);

            // メンバー追加
            const addMember = async () => {
                if (!newMemberEmail) return;
                if (!newMemberEmail.includes('@')) return alert("正しいメールアドレスを入力してください");
                
                const { error } = await supabase
                    .from('team_members')
                    .insert([{ manager_email: user.email, member_email: newMemberEmail }]);

                if (error) alert("追加エラー: " + error.message);
                else {
                    alert(`${newMemberEmail} をチームに追加しました。\nデータが見えるようになります。`);
                    setNewMemberEmail("");
                    refreshData();
                }
            };

            // メンバー削除
            const removeMember = async (id) => {
                if(!confirm("このメンバーをチームから外しますか？")) return;
                await supabase.from('team_members').delete().eq('id', id);
                refreshData();
            };

            // 集計・グラフ
            const filteredExpenses = expenses.filter(item => {
                const itemMonth = item.date.replace('/', '-').slice(0, 7); // YYYY-MM
                const isMonth = itemMonth === filterMonth.replace('/', '-'); // 簡易一致
                const isUser = filterUser ? item.user_email === filterUser : true;
                return isMonth && isUser; // 日付形式による不一致を防ぐため実際はもう少し柔軟にすべきだが簡易実装
            });

            const totalAmount = filteredExpenses.reduce((sum, item) => sum + (item.amount || 0), 0);
            const userList = [...new Set(expenses.map(e => e.user_email))]; // データが存在するユーザー

            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (view !== 'dashboard' || !chartRef.current) return;
                const categorySums = {};
                filteredExpenses.forEach(d => { categorySums[d.category] = (categorySums[d.category] || 0) + d.amount; });
                
                const ctx = chartRef.current.getContext('2d');
                if (chartInstance.current) chartInstance.current.destroy();
                chartInstance.current = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(categorySums),
                        datasets: [{
                            data: Object.values(categorySums),
                            backgroundColor: ['#3b82f6', '#f97316', '#22c55e', '#eab308', '#a855f7', '#64748b']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }, [filteredExpenses, view]);

            const downloadCSV = () => {
                if (filteredExpenses.length === 0) return alert("データがありません");
                const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
                let csv = "日付,担当者,科目,金額,メモ\n";
                filteredExpenses.forEach(d => { csv += `${d.date},${d.user_email},${d.category},${d.amount},${d.memo}\n`; });
                const blob = new Blob([bom, csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `経費_${filterMonth}.csv`; a.click();
            };

            return (
                <div className="min-h-screen flex flex-col">
                    <header className="bg-slate-900 text-white p-4 shadow flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            <h1 className="font-bold text-lg"><span className="bg-blue-600 text-xs px-2 py-1 rounded mr-2">ADMIN</span>ロクマル</h1>
                            <nav className="flex bg-slate-800 rounded p-1">
                                <button onClick={() => setView('dashboard')} className={`px-3 py-1 text-sm rounded ${view === 'dashboard' ? 'bg-slate-600' : 'text-slate-400'}`}>集計</button>
                                <button onClick={() => setView('members')} className={`px-3 py-1 text-sm rounded ${view === 'members' ? 'bg-slate-600' : 'text-slate-400'}`}>メンバー管理</button>
                            </nav>
                        </div>
                        <div className="flex items-center gap-3">
                            <span className="text-xs text-slate-400 hidden sm:inline">{user.email}</span>
                            <button onClick={refreshData} className="p-2 hover:bg-slate-800 rounded"><Icon name="refresh-cw"/></button>
                            <button onClick={onLogout} className="p-2 hover:bg-red-900 text-red-300 rounded"><Icon name="log-out"/></button>
                        </div>
                    </header>

                    <div className="flex-1 p-6 max-w-6xl mx-auto w-full space-y-6">
                        {/* ダッシュボード */}
                        {view === 'dashboard' && (
                            <React.Fragment>
                                <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-wrap gap-4 items-end">
                                    <div><label className="text-xs font-bold text-slate-500 block mb-1">対象月</label><input type="month" value={filterMonth} onChange={e => setFilterMonth(e.target.value)} className="border p-2 rounded text-sm"/></div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 block mb-1">担当者</label>
                                        <select value={filterUser} onChange={e => setFilterUser(e.target.value)} className="border p-2 rounded text-sm min-w-[150px]">
                                            <option value="">全員 ({userList.length}人)</option>
                                            {userList.map(u => <option key={u} value={u}>{u}</option>)}
                                        </select>
                                    </div>
                                    <button onClick={downloadCSV} className="ml-auto bg-green-600 text-white px-4 py-2 rounded font-bold text-sm flex items-center"><Icon name="download" className="mr-2"/>CSV出力</button>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="bg-white p-6 rounded-xl shadow border border-slate-200">
                                        <p className="text-slate-500 text-xs font-bold">合計金額</p>
                                        <p className="text-3xl font-bold text-slate-800 mt-1">¥ {totalAmount.toLocaleString()}</p>
                                        <p className="text-xs text-slate-400 mt-2">{filteredExpenses.length} 件</p>
                                    </div>
                                    <div className="bg-white p-4 rounded-xl shadow border border-slate-200 md:col-span-2 h-64 relative">
                                        <div className="h-full w-full"><canvas ref={chartRef}></canvas></div>
                                    </div>
                                </div>

                                <div className="bg-white rounded-xl shadow border border-slate-200 overflow-hidden">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-slate-50 text-slate-500 border-b">
                                            <tr><th className="p-3">日付</th><th className="p-3">担当者</th><th className="p-3">科目</th><th className="p-3">金額</th></tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {filteredExpenses.map(item => (
                                                <tr key={item.id}>
                                                    <td className="p-3">{item.date.split(' ')[0]}</td>
                                                    <td className="p-3 text-slate-600 text-xs">{item.user_email}</td>
                                                    <td className="p-3"><span className="bg-slate-100 px-2 py-0.5 rounded text-xs">{item.category}</span></td>
                                                    <td className="p-3 font-bold">¥ {item.amount.toLocaleString()}</td>
                                                </tr>
                                            ))}
                                            {filteredExpenses.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-slate-400">データなし</td></tr>}
                                        </tbody>
                                    </table>
                                </div>
                            </React.Fragment>
                        )}

                        {/* メンバー管理 */}
                        {view === 'members' && (
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden p-6">
                                <h2 className="font-bold text-lg mb-4">チームメンバー管理</h2>
                                <div className="flex gap-2 mb-8">
                                    <input 
                                        type="email" 
                                        placeholder="従業員のGmailアドレスを入力" 
                                        className="border p-2 rounded flex-1"
                                        value={newMemberEmail}
                                        onChange={e => setNewMemberEmail(e.target.value)}
                                    />
                                    <button onClick={addMember} className="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700">追加</button>
                                </div>

                                <h3 className="font-bold text-sm text-slate-500 mb-2">登録済みメンバー ({members.length}人)</h3>
                                <div className="border rounded divide-y">
                                    {members.map(m => (
                                        <div key={m.id} className="p-3 flex justify-between items-center">
                                            <span className="font-bold text-slate-700">{m.member_email}</span>
                                            <button onClick={() => removeMember(m.id)} className="text-red-400 hover:text-red-600 text-xs underline">削除</button>
                                        </div>
                                    ))}
                                    {members.length === 0 && <p className="p-4 text-center text-slate-400 text-sm">メンバーはまだ登録されていません</p>}
                                </div>
                                <p className="mt-4 text-xs text-slate-400">※ここに登録されたメールアドレスのユーザーが入力したデータは、自動的にあなたのダッシュボードに表示されます。</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- ルート ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const init = async () => {
                    let attempts = 0;
                    while (!window.supabase && attempts < 50) { await new Promise(r => setTimeout(r, 100)); attempts++; }
                    if (window.supabase) {
                        supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseKey);
                        const { data: { session } } = await supabase.auth.getSession();
                        setUser(session ? session.user : null);
                        supabase.auth.onAuthStateChange((_event, session) => setUser(session ? session.user : null));
                    }
                    setLoading(false);
                };
                init();
            }, []);

            const logout = async () => { if(supabase) await supabase.auth.signOut(); };

            if (loading) return <div className="min-h-screen flex items-center justify-center bg-slate-900 text-white">Loading...</div>;
            if (!user) return <AuthScreen />;
            return <AdminDashboard user={user} onLogout={logout} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
